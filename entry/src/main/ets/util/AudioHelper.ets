import media from '@ohos.multimedia.media';
import common from '@ohos.app.ability.common';

class AudioHelper {
  private static instance: AudioHelper;
  private avPlayer: media.AVPlayer | null = null;
  private isPlaying: boolean = false;

  private constructor() {}

  public static getInstance(): AudioHelper {
    if (!AudioHelper.instance) {
      AudioHelper.instance = new AudioHelper();
    }
    return AudioHelper.instance;
  }

  // åˆå§‹åŒ–æ’­æ”¾å™¨
  async init() {
    if (this.avPlayer) return;
    try {
      // åˆ›å»ºæ’­æ”¾å™¨å®ä¾‹
      this.avPlayer = await media.createAVPlayer();

      // ç›‘å¬çŠ¶æ€å˜åŒ–
      this.avPlayer.on('stateChange', async (state, reason) => {
        switch (state) {
          case 'initialized':
            if (this.avPlayer) await this.avPlayer.prepare();
            break;
          case 'prepared':
            if (this.avPlayer) await this.avPlayer.play();
            break;
          case 'completed':
            this.isPlaying = false;
            break;
          case 'error':
            this.isPlaying = false;
            console.error('æ’­æ”¾å™¨é”™è¯¯');
            break;
        }
      });
    } catch (e) {
      console.error(`æ’­æ”¾å™¨åˆå§‹åŒ–å¤±è´¥: ${JSON.stringify(e)}`);
    }
  }

  // æ ¸å¿ƒåŠŸèƒ½ï¼šæ’­æ”¾å•è¯
  async speak(word: string) {
    if (!word) return;

    // ç¡®ä¿å·²åˆå§‹åŒ–
    if (!this.avPlayer) await this.init();

    if (this.avPlayer) {
      try {
        // å¦‚æœæ­£åœ¨æ’­æ”¾ï¼Œå…ˆé‡ç½®
        if (this.avPlayer.state === 'playing') {
          await this.avPlayer.reset();
        } else if (this.avPlayer.state !== 'idle' && this.avPlayer.state !== 'initialized') {
          await this.avPlayer.reset();
        }

        // âœ… ä½¿ç”¨æœ‰é“è¯å…¸çš„å…è´¹ API (type=1 è‹±éŸ³, type=2 ç¾éŸ³)
        // è¿™ä¸ª URL åœ¨æµè§ˆå™¨é‡Œä¹Ÿèƒ½ç›´æ¥æ‰“å¼€å¬
        let url = `https://dict.youdao.com/dictvoice?audio=${encodeURIComponent(word)}&type=2`;

        this.avPlayer.url = url;
        // è®¾ç½® url åï¼Œæ’­æ”¾å™¨ä¼šè‡ªåŠ¨è§¦å‘ 'initialized' -> 'prepared' -> 'play'

        console.info(`ğŸ”Š æ­£åœ¨æ’­æ”¾: ${word}`);
      } catch (e) {
        console.error(`æ’­æ”¾å¤±è´¥: ${JSON.stringify(e)}`);
      }
    }
  }

  // é‡Šæ”¾èµ„æº
  async release() {
    if (this.avPlayer) {
      await this.avPlayer.release();
      this.avPlayer = null;
    }
  }
}

export default AudioHelper.getInstance();
//ç”±äºè”ç½‘å¯èƒ½è¦æ±‚å¤‡æ¡ˆï¼ŒçœŸäººå‘éŸ³æš‚æ—¶å–æ¶ˆ