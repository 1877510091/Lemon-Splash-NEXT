// å°è¯•ä½¿ç”¨æ–°ç‰ˆ Kit å¯¼å…¥
import { textToSpeech } from '@kit.CoreSpeechKit';
import common from '@ohos.app.ability.common';

class TTSHelper {
  private static instance: TTSHelper;
  private ttsEngine: textToSpeech.TextToSpeechEngine | null = null;
  private isCreating: boolean = false;

  private constructor() {}

  public static getInstance(): TTSHelper {
    if (!TTSHelper.instance) {
      TTSHelper.instance = new TTSHelper();
    }
    return TTSHelper.instance;
  }

  async init() {
    if (this.ttsEngine || this.isCreating) return;
    this.isCreating = true;

    try {
      // 1. é…ç½®å‚æ•°
      let extraParams: Record<string, Object> = {};
      let createParams: textToSpeech.CreateEngineParams = {
        language: 'en-US',
        person: 0,
        online: 1,
        extraParams: extraParams
      };

      // 2. åˆ›å»ºå¼•æ“
      this.ttsEngine = await textToSpeech.createEngine(createParams);
      console.info('âœ… ç¦»çº¿ TTS å¼•æ“åˆå§‹åŒ–æˆåŠŸ');

      // âŒ å·²åˆ é™¤æŠ¥é”™çš„ .on('error') ç›‘å¬ä»£ç 
      // è¿™æ ·èƒ½ç¡®ä¿è¯ç¼–è¯‘é€šè¿‡

    } catch (e) {
      console.error(`âŒ TTS åˆå§‹åŒ–å¤±è´¥: ${JSON.stringify(e)}`);
    } finally {
      this.isCreating = false;
    }
  }

  async speak(text: string) {
    if (!this.ttsEngine) {
      await this.init();
    }

    if (this.ttsEngine) {
      try {
        let extraParams: Record<string, Object> = {
          "speed": 1.0,
          "volume": 1.0,
          "pitch": 1.0,
          "queueMode": 0
        };

        let speakParams: textToSpeech.SpeakParams = {
          requestId: Date.now().toString(),
          extraParams: extraParams
        };

        console.info(`ğŸ”Š æ’­æ”¾: ${text}`);
        this.ttsEngine.speak(text, speakParams);
      } catch (e) {
        console.error(`âŒ å‘éŸ³å¤±è´¥: ${JSON.stringify(e)}`);
      }
    }
  }
}

export default TTSHelper.getInstance();