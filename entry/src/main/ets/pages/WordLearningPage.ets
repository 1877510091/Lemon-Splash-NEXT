import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import DatabaseHelper from '../model/DatabaseHelper';
import TTSHelper from '../util/TTSHelper';
import { Word, StudyProgress } from '../model/WordModel';

@Entry
@Component
struct WordLearningPage {
  @State progress: number = 0;
  @State currentWordIndex: number = 0;
  @State currentWords: Word[] = [];
  @State isLoading: boolean = true;
  @State currentGroup: number = 0;

  aboutToAppear() {
    this.loadData();
  }

  async loadData() {
    this.isLoading = true;
    try {
      let bookName = await DatabaseHelper.getLastBook();
      if (!bookName) bookName = "å››çº§è¯æ±‡";

      let progressObj = await DatabaseHelper.getStudyProgress(bookName);
      this.currentGroup = progressObj.currentGroup;

      let words = await DatabaseHelper.getWordsByGroup(bookName, this.currentGroup, 20);

      if (words.length === 0) {
        try {
          promptAction.showToast({ message: 'æœ¬ç»„å•è¯ä¸ºç©ºï¼Œè¯·æ£€æŸ¥è¯åº“' });
        } catch (error) {}
        this.isLoading = false;
        return;
      }

      let firstUnlearnedIndex = 0;
      for (let i = 0; i < words.length; i++) {
        if (words[i].status === 0) {
          firstUnlearnedIndex = i;
          break;
        }
      }

      this.currentWords = words;
      this.currentWordIndex = firstUnlearnedIndex;
      this.updateProgress();
      this.isLoading = false;

      if (this.currentWords.length > 0) {
        TTSHelper.speak(this.currentWords[this.currentWordIndex].word);
      }

    } catch (e) {
      console.error('åŠ è½½å¤±è´¥:', JSON.stringify(e as object));
      this.isLoading = false;
    }
  }

  updateProgress() {
    if (this.currentWords.length > 0) {
      this.progress = (this.currentWordIndex + 1) / this.currentWords.length * 100;
    } else {
      this.progress = 0;
    }
  }

  async handleUserAction(isKnown: boolean) {
    if (this.currentWordIndex >= this.currentWords.length) return;

    let word = this.currentWords[this.currentWordIndex];
    if (word.id !== null) {
      await DatabaseHelper.markWordAsLearned(word.id, !isKnown);
    }

    if (this.currentWordIndex < this.currentWords.length - 1) {
      this.currentWordIndex++;
      this.updateProgress();
      TTSHelper.speak(this.currentWords[this.currentWordIndex].word);
    } else {
      this.showFinishDialog();
    }
  }

  async startNextGroup() {
    if (this.currentWords.length > 0) {
      let bookName = this.currentWords[0].bookName;
      await DatabaseHelper.saveStudyProgress(new StudyProgress(bookName, this.currentGroup + 1));
      this.loadData();
    }
  }

  showFinishDialog() {
    AlertDialog.show({
      title: 'ğŸ‰ æœ¬ç»„å®Œæˆ',
      message: 'å¤ªæ£’äº†ï¼ä¼‘æ¯ä¸€ä¸‹è¿˜æ˜¯ç»§ç»­ï¼Ÿ',
      autoCancel: false,
      alignment: DialogAlignment.Center,
      primaryButton: {
        value: 'å†å¤ä¹ ä¸€é',
        action: () => {
          this.currentWordIndex = 0;
          this.updateProgress();
        }
      },
      secondaryButton: {
        value: 'ä¸‹ä¸€ç»„',
        fontColor: '#009688',
        action: () => {
          this.startNextGroup();
        }
      }
    });
  }

  handleUndo() {
    if (this.currentWordIndex > 0) {
      this.currentWordIndex--;
      this.updateProgress();
      TTSHelper.speak(this.currentWords[this.currentWordIndex].word);
    } else {
      try { promptAction.showToast({ message: 'å·²ç»æ˜¯ç¬¬ä¸€ä¸ªäº†' }); } catch(e) {}
    }
  }

  build() {
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        SymbolGlyph($r('sys.symbol.chevron_left'))
          .fontSize(24).fontColor(['#004D40'])
          .onClick(() => router.back())

        Text(`åˆ†ç»„: ${this.currentGroup + 1} | è¿›åº¦: ${this.currentWordIndex + 1}/${this.currentWords.length}`)
          .fontSize(18).fontColor('#004D40').fontWeight(FontWeight.Bold)
          .layoutWeight(1).textAlign(TextAlign.Center)

        Blank().width(24)
      }
      .height(56).padding({ left: 16, right: 16 })

      // è¿›åº¦æ¡
      Progress({ value: this.progress, total: 100, type: ProgressType.Linear })
        .color('#CDDC39').backgroundColor(Color.White).height(4).width('100%')

      Blank().layoutWeight(1)

      if (this.isLoading) {
        LoadingProgress().color('#009688').width(50).height(50)
        Text("åŠ è½½ä¸­...").fontSize(14).fontColor(Color.Gray).margin({ top: 10 })
        Blank().layoutWeight(2)
      } else if (this.currentWords.length > 0) {
        // === å•è¯å¡ç‰‡ ===
        Column() {

          // âœ… æ ¸å¿ƒä¿®æ”¹ï¼šæ™ºèƒ½å¼¹æ€§æ–‡æœ¬
          Text(this.currentWords[this.currentWordIndex].word)
            .fontWeight(FontWeight.Bold)
            .fontColor('#004D40')
            .fontFamily('Georgia')
            .textAlign(TextAlign.Center)
            // â¬‡ï¸ å…³é”®å±æ€§é…ç½®
            .maxLines(2)                  // 1. æœ€å¤šå…è®¸ä¸¤è¡Œ
            .minFontSize(32)              // 2. æœ€å°å­—å·é™åˆ¶åœ¨32ï¼Œé˜²æ­¢ç¼©å¤ªå°çœ‹ä¸æ¸…
            .maxFontSize(48)              // 3. æ­£å¸¸æœ€å¤§å­—å·48
            .heightAdaptivePolicy(TextHeightAdaptivePolicy.MIN_FONT_SIZE_FIRST) // 4. ç­–ç•¥ï¼šä¼˜å…ˆç¼©å°å­—å·ï¼Œç¼©ä¸åŠ¨äº†å†æ¢è¡Œ
            .textOverflow({ overflow: TextOverflow.Ellipsis }) // 5. å®åœ¨ä¸è¡Œæ‰çœç•¥å·
            .width('100%')

          Row() {
            Text(`/${this.currentWords[this.currentWordIndex].phonetic}/`)
              .fontSize(20).fontColor('#827717').margin({ right: 10 })

            SymbolGlyph($r('sys.symbol.speaker_wave_2'))
              .fontSize(24).fontColor(['#4DB6AC'])
              .onClick(() => {
                TTSHelper.speak(this.currentWords[this.currentWordIndex].word);
              })
          }
          .margin({ top: 10, bottom: 30 })

          Scroll() {
            Column() {
              Text(this.currentWords[this.currentWordIndex].definition)
                .fontSize(18).fontColor('#757575').textAlign(TextAlign.Center).lineHeight(28)

              if (this.currentWords[this.currentWordIndex].example) {
                Divider().color('#BDBDBD').margin({ top: 15, bottom: 15 }).width('80%')
                Text(this.currentWords[this.currentWordIndex].example)
                  .fontSize(16).fontColor('#00695C').fontStyle(FontStyle.Italic).textAlign(TextAlign.Center)
              }
            }
          }
          .height(150)
        }
        .width('85%')
        .padding({ top: 40, bottom: 40, left: 30, right: 30 })
        .backgroundColor(Color.White)
        .borderRadius(40)
        .shadow({ radius: 30, color: 'rgba(0, 150, 136, 0.1)', offsetY: 15 })

        Blank().layoutWeight(2)

        // === åº•éƒ¨æŒ‰é’®åŒº ===
        Row() {
          // --- å·¦ä¾§ï¼šå¿˜è®° + æ’¤é”€ ---
          Column() {
            // å¿˜è®°æŒ‰é’®
            Column() {
              Stack() {
                Circle({ width: 75, height: 75 }).fill('#FFEBEE')
                SymbolGlyph($r('sys.symbol.xmark')).fontSize(32).fontColor(['#E57373'])
              }
              Text("å¿˜è®°").fontSize(16).fontWeight(FontWeight.Bold).fontColor('#E57373').margin({ top: 8 })
            }
            .onClick(() => this.handleUserAction(false))

            // æ’¤é”€æŒ‰é’®
            Row() {
              SymbolGlyph($r('sys.symbol.arrow_left')).fontSize(18).fontColor(['#757575'])
              Text("æ’¤é”€").fontSize(14).fontWeight(FontWeight.Bold).fontColor('#757575').margin({ left: 4 })
            }
            .margin({ top: 20 })
            .padding({ left: 16, right: 16, top: 6, bottom: 6 })
            .backgroundColor(Color.White)
            .borderRadius(20)
            .border({ width: 1, color: '#E0E0E0' })
            .onClick(() => this.handleUndo())
          }

          // --- ä¸­é—´é—´è· ---
          Blank().width(70)

          // --- å³ä¾§ï¼šè®¤è¯† ---
          Column() {
            Column() {
              Stack() {
                Circle({ width: 75, height: 75 }).fill('#F0F4C3')
                SymbolGlyph($r('sys.symbol.checkmark')).fontSize(32).fontColor(['#9E9D24'])
              }
              Text("è®¤è¯†").fontSize(16).fontWeight(FontWeight.Bold).fontColor('#9E9D24').margin({ top: 8 })
            }
            .onClick(() => this.handleUserAction(true))

            Blank().height(40).margin({ top: 20 })
          }
        }
        .alignItems(VerticalAlign.Top)
        .padding({ bottom: 40 })

      } else {
        // ç©ºçŠ¶æ€å…œåº•
        Text("è¿˜æ²¡æœ‰é€‰æ‹©è¯ä¹¦ï¼Œè¯·å…ˆå»å›¾ä¹¦é¦†é€‰æ‹©ä¸€æœ¬å§ï¼")
          .fontColor(Color.Gray)
          .margin({ top: 100 })
        Blank().layoutWeight(2)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#E0F2F1')
    .padding({ top: 48 })
  }
}