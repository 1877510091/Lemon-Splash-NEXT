import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import DatabaseHelper from '../model/DatabaseHelper';
import TTSHelper from '../util/TTSHelper';
import { Word } from '../model/WordModel';

@Entry
@Component
struct ReviewPage {
  @State showAnswer: boolean = false;
  @State reviewWords: Word[] = [];
  @State currentIndex: number = 0;
  @State isLoading: boolean = true;

  aboutToAppear() {
    this.loadData();
  }

  async loadData() {
    this.isLoading = true;
    try {
      this.reviewWords = await DatabaseHelper.getWordsDueForReview();
      this.currentIndex = 0;
      this.showAnswer = false;

      if (this.reviewWords.length > 0) {
        TTSHelper.speak(this.reviewWords[0].word);
      }
    } catch (e) {
      console.error('å¤ä¹ æ•°æ®åŠ è½½å¤±è´¥:', JSON.stringify(e as object));
    } finally {
      this.isLoading = false;
    }
  }

  async handleResult(remembered: boolean) {
    if (this.currentIndex >= this.reviewWords.length) return;

    let word = this.reviewWords[this.currentIndex];

    if (word.id !== null) {
      await DatabaseHelper.processReview(word.id, remembered, word.reviewStage);
    }

    if (this.currentIndex < this.reviewWords.length - 1) {
      this.currentIndex++;
      this.showAnswer = false;
      TTSHelper.speak(this.reviewWords[this.currentIndex].word);
    } else {
      AlertDialog.show({
        title: 'ðŸŽ‰ å¤ä¹ å®Œæˆ',
        message: 'ä»Šå¤©çš„å¤ä¹ ä»»åŠ¡å·²æ¸…ç©ºï¼',
        autoCancel: false,
        alignment: DialogAlignment.Center,
        confirm: {
          value: 'è¿”å›žé¦–é¡µ',
          action: () => { router.back(); }
        }
      });
    }
  }

  build() {
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        SymbolGlyph($r('sys.symbol.chevron_left')).fontSize(24).fontColor(['#0D47A1']).onClick(() => router.back())
        Text("æ™ºèƒ½å¤ä¹ ").fontSize(18).fontColor('#0D47A1').fontWeight(FontWeight.Bold).layoutWeight(1).textAlign(TextAlign.Center)
        Blank().width(24)
      }
      .height(56).padding({ left: 16, right: 16 })

      if (this.reviewWords.length > 0) {
        Progress({ value: this.currentIndex + 1, total: this.reviewWords.length })
          .color('#2196F3').backgroundColor(Color.White).height(4).width('100%')
      }

      // âœ… ä¿®å¤2ï¼šç©ºçŠ¶æ€é¡µé¢å±…ä¸­ & æ–‡æ¡ˆä¿®æ”¹
      if (this.isLoading) {
        Column() {
          Text("æ­£åœ¨è®¡ç®—å¤ä¹ é˜Ÿåˆ—...").fontColor(Color.Gray)
        }
        .width('100%').layoutWeight(1).justifyContent(FlexAlign.Center)
      } else if (this.reviewWords.length === 0) {
        Column() {
          // æ”¾åœ¨å±å¹•ä¸­é—´
          SymbolGlyph($r('sys.symbol.checkmark_circle')).fontSize(60).fontColor(['#4CAF50']).margin({ bottom: 20 })

          Text("å¤ä¹ ç®—æ³•ä¼šæ ¹æ®è‰¾å®¾æµ©æ–¯é—å¿˜æ›²çº¿\nåœ¨å‡ å¤©åŽæ•´ç†éœ€è¦å¤ä¹ çš„å•è¯") // âœ… æ–‡æ¡ˆä¿®æ”¹
            .fontSize(16)
            .textAlign(TextAlign.Center)
            .fontColor(Color.Gray)
            .lineHeight(26) // å¢žåŠ è¡Œé«˜ï¼Œæ›´å¥½çœ‹
        }
        .width('100%')
        .layoutWeight(1) // å æ»¡å‰©ä½™é«˜åº¦
        .justifyContent(FlexAlign.Center) // âœ… åž‚ç›´å±…ä¸­
        .padding({ bottom: 56 }) // ç¨å¾®å¾€ä¸Šæä¸€ç‚¹ï¼Œè§†è§‰æ›´å¹³è¡¡
      } else {
        Blank().layoutWeight(1)

        // === å¤ä¹ å¡ç‰‡ ===
        Column() {
          Text(this.reviewWords[this.currentIndex].word)
            .fontSize(48).fontWeight(FontWeight.Bold).fontColor('#0D47A1').fontFamily('Georgia').textAlign(TextAlign.Center)

          Row() {
            SymbolGlyph($r('sys.symbol.speaker_wave_2')).fontSize(24).fontColor(['#2196F3'])
              .onClick(() => { TTSHelper.speak(this.reviewWords[this.currentIndex].word); })
          }.margin({ top: 10 })

          if (this.showAnswer) {
            Text(`/${this.reviewWords[this.currentIndex].phonetic}/`).fontSize(20).fontColor('#1976D2').margin({ top: 20, bottom: 20 })
            Text(this.reviewWords[this.currentIndex].definition)
              .fontSize(18).fontColor('#757575').textAlign(TextAlign.Center)
          } else {
            Blank().height(50)
            Text("ç‚¹å‡»æŸ¥çœ‹é‡Šä¹‰").fontSize(14).fontColor(Color.Gray).margin({ top: 30, bottom: 30 })
            Blank().height(50)
          }
        }
        .width('85%')
        .padding({ top: 60, bottom: 60, left: 30, right: 30 })
        .backgroundColor(Color.White)
        .borderRadius(40)
        .shadow({ radius: 30, color: 'rgba(33, 150, 243, 0.1)', offsetY: 15 })

        Blank().layoutWeight(2)

        // === åº•éƒ¨æŒ‰é’® ===
        if (!this.showAnswer) {
          Button("æŸ¥çœ‹ç­”æ¡ˆ")
            .backgroundColor('#BBDEFB')
            .fontColor('#0D47A1')
            .fontWeight(FontWeight.Bold)
            .width(160)
            .height(50)
            .onClick(() => this.showAnswer = true)
        } else {
          Row() {
            Column() {
              Stack() {
                Circle({ width: 70, height: 70 }).fill('#FFEBEE')
                SymbolGlyph($r('sys.symbol.xmark')).fontSize(30).fontColor(['#E57373'])
              }
              Text("å¿˜è®°äº†").fontSize(14).fontWeight(FontWeight.Bold).fontColor('#E57373').margin({ top: 8 })
            }
            .onClick(() => this.handleResult(false))

            Blank().width(50)

            Column() {
              Stack() {
                Circle({ width: 70, height: 70 }).fill('#F0F4C3')
                SymbolGlyph($r('sys.symbol.checkmark')).fontSize(30).fontColor(['#9E9D24'])
              }
              Text("è®°å¾—").fontSize(14).fontWeight(FontWeight.Bold).fontColor('#9E9D24').margin({ top: 8 })
            }
            .onClick(() => this.handleResult(true))
          }
        }
        Blank().height(50)
      }
    }
    .width('100%').height('100%')
    .backgroundColor('#E3F2FD')
    .padding({ top: 48 })
  }
}